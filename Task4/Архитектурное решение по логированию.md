# Архитектурное решение по логированию

## Анализ системы в контексте логирования

### Текущие проблемы с диагностикой
1. **Разбор проблем со слов клиента** - нет системного подхода к диагностике
2. **Долгое время диагностики** - разработчики тратят часы на поиск проблем
3. **Высокая нагрузка на поддержку** - отсутствие автоматизации диагностики
4. **Отсутствие централизованного логирования** - логи разбросаны по разным системам
5. **Нет структурированных логов** - сложно анализировать и искать проблемы

### Системы, требующие сбора логов

#### 1. Онлайн-магазин (Vue + Java Spring Boot)
- **Критические операции**: Создание заказа, загрузка файла, оплата
- **Проблемные места**: Таймауты, ошибки валидации, проблемы с файлами
- **Типы логов**: HTTP запросы, бизнес-операции, ошибки

#### 2. CRM (Vue + Java Spring Boot)
- **Критические операции**: Управление клиентами, изменение статусов заказов
- **Проблемные места**: Потеря уведомлений, дублирование статусов
- **Типы логов**: Пользовательские действия, изменения данных, интеграции

#### 3. MES (React + C#)
- **Критические операции**: Расчет стоимости, изменение статуса заказа, производственные процессы
- **Проблемные места**: Долгие расчеты, зависание процессов, ошибки расчетов
- **Типы логов**: Производственные операции, расчеты, статусы заказов

#### 4. RabbitMQ
- **Критические операции**: Передача сообщений между системами
- **Проблемные места**: Потеря сообщений, задержки, dead letter queues
- **Типы логов**: Сообщения, очереди, ошибки доставки

#### 5. База данных (PostgreSQL)
- **Критические операции**: Все операции с данными
- **Проблемные места**: Медленные запросы, блокировки, ошибки
- **Типы логов**: SQL запросы, транзакции, ошибки

#### 6. 3d files storage (S3-based)
- **Критические операции**: Загрузка/скачивание 3D файлов
- **Проблемные места**: Ошибки загрузки, таймауты, проблемы с форматами
- **Типы логов**: Операции с файлами, ошибки доступа, размеры файлов

## Необходимые логи с уровнем INFO

### 1. Бизнес-операции (INFO)
- **Создание заказа**: время, ID клиента, ID заказа, источник (онлайн-магазин/API)
- **Изменение статуса заказа**: время, ID заказа, старый статус, новый статус, пользователь
- **Загрузка файла**: время, ID заказа, размер файла, тип файла, результат
- **Расчет стоимости**: время, ID заказа, сложность модели, время расчета, результат
- **Отправка уведомления**: время, ID заказа, тип уведомления, получатель, статус

### 2. Пользовательские действия (INFO)
- **Вход в систему**: время, ID пользователя, IP адрес, результат
- **Изменение данных**: время, ID пользователя, тип изменения, старые/новые значения
- **Поиск заказов**: время, ID пользователя, критерии поиска, количество результатов
- **Экспорт данных**: время, ID пользователя, тип данных, количество записей

### 3. Интеграции (INFO)
- **Отправка сообщения в RabbitMQ**: время, очередь, тип сообщения, размер, статус
- **Получение сообщения из RabbitMQ**: время, очередь, тип сообщения, обработчик
- **API вызовы**: время, endpoint, метод, статус код, время ответа
- **Внешние API**: время, сервис, endpoint, статус, время ответа

### 4. Системные операции (INFO)
- **Запуск/остановка сервиса**: время, сервис, версия, статус
- **Изменение конфигурации**: время, сервис, параметр, старое/новое значение
- **Резервное копирование**: время, тип, размер, статус
- **Масштабирование**: время, сервис, количество инстансов, причина

## Другие уровни логирования

### DEBUG
- **Детальная информация о выполнении**: параметры функций, промежуточные результаты
- **SQL запросы**: полные запросы с параметрами
- **HTTP заголовки**: детальная информация о запросах
- **Внутренние состояния**: состояние объектов, переменных

### WARN
- **Потенциальные проблемы**: медленные операции, нестандартные ситуации
- **Deprecated функции**: использование устаревших API
- **Конфигурационные предупреждения**: неоптимальные настройки
- **Ресурсные предупреждения**: высокое использование памяти/CPU

### ERROR
- **Ошибки приложения**: исключения, сбои в бизнес-логике
- **Ошибки интеграции**: сбои в API, потеря сообщений
- **Ошибки базы данных**: проблемы с подключением, SQL ошибки
- **Системные ошибки**: проблемы с файловой системой, сетью

### FATAL
- **Критические ошибки**: невозможность запуска сервиса
- **Потеря данных**: критические сбои в работе с данными
- **Системные сбои**: проблемы с инфраструктурой

## Мотивация

### Почему нужно логирование
1. **Бизнес-критичность**: Потеря заказов напрямую влияет на выручку
2. **Сложность системы**: 3 приложения + интеграции требуют централизованного подхода
3. **Рост нагрузки**: +100 заказов в месяц требует лучшей диагностики
4. **Качество сервиса**: Клиенты жалуются на проблемы, нужна быстрая диагностика
5. **Операционная эффективность**: Команда тратит много времени на поиск проблем

### Что даст логирование компании
- **Быстрая диагностика** проблем (снижение MTTR с часов до минут)
- **Проактивное выявление** проблем до их влияния на клиентов
- **Автоматизация** диагностики и алертинга
- **Улучшение качества** через анализ паттернов ошибок
- **Снижение операционных расходов** через автоматизацию

## Технические и бизнес-метрики

### Технические метрики
1. **Log Volume** - объем логов в единицу времени
2. **Error Rate** - процент ошибок в логах
3. **Response Time** - время ответа на основе логов
4. **Throughput** - количество операций в единицу времени
5. **Availability** - доступность сервисов на основе логов

### Бизнес-метрики
1. **Order Processing Time** - время обработки заказов
2. **Customer Satisfaction** - количество жалоб и их причины
3. **API Usage** - использование внешнего API
4. **File Upload Success Rate** - успешность загрузки файлов
5. **Price Calculation Success Rate** - успешность расчетов стоимости

## Приоритизация систем для логирования и трейсинга

### Первая очередь (критически важно)
1. **MES** - производственные процессы критичны для бизнеса
2. **RabbitMQ** - интеграция между системами
3. **База данных** - все операции с данными

### Вторая очередь (важно)
4. **CRM** - управление клиентами
5. **3d files storage** - операции с файлами

### Третья очередь (желательно)
6. **Онлайн-магазин** - B2C операции

### Обоснование приоритизации
- **MES**: Критично для производства, долгие операции, высокая сложность
- **RabbitMQ**: Критично для интеграции, часто теряются сообщения
- **База данных**: Критично для всех операций, часто источник проблем
- **CRM**: Важно для операций, но менее критично
- **3d files storage**: Важно для файловых операций, но менее критично
- **Онлайн-магазин**: Менее критично, стандартные веб-операции

## Предлагаемое решение

### Обновленная диаграмма контейнеров

[Ссылка на диаграмму: architecture-alexandrite-with-logging.drawio]

**Примечание**: Диаграмма основана на оригинальной C4 диаграмме Александрита из задания 3 (architecture-alexandrite-with-tracing-and-automation.drawio) и включает все компоненты логирования согласно требованиям задания.

#### Компоненты логирования (выделены оранжевым):
1. **Filebeat** - сбор логов с каждого сервера
2. **Logstash** - обработка и обогащение логов
3. **Elasticsearch** - хранение и индексация логов
4. **Kibana** - визуализация и анализ логов

#### Связи логирования (выделены оранжевым):
1. Приложения → Filebeat (сбор логов)
2. Filebeat → Logstash (передача логов)
3. Logstash → Elasticsearch (хранение)
4. Kibana → Elasticsearch (анализ)

### Технологический стек
- **ELK Stack**: Elasticsearch, Logstash, Kibana
- **Filebeat**: сбор логов с серверов
- **Logstash**: обработка и обогащение логов
- **Elasticsearch**: хранение и поиск логов
- **Kibana**: визуализация и анализ логов

### Архитектура решения

#### 1. Сбор логов
- **Filebeat** на каждом сервере для сбора логов из файлов приложений
- **Структурированные логи** в JSON формате со стандартными полями

#### 2. Обработка логов
- **Logstash** для парсинга, обогащения и трансформации логов

#### 3. Хранение и поиск
- **Elasticsearch** для индексирования, хранения и быстрого поиска логов

#### 4. Анализ и визуализация
- **Kibana** для дашбордов, поиска и анализа логов

### Политика безопасности логов

#### 1. Обработка чувствительных данных
- **Маскирование PII**: автоматическое скрытие персональных данных
- **Шифрование**: TLS для передачи, шифрование в покое
- **Access Control**: ролевая модель доступа к логам
- **Аудит**: логирование всех действий с логами

#### 2. Контроль доступа
- **Операторы**: доступ к логам заказов и производственных процессов
- **Разработчики**: доступ к техническим логам и ошибкам
- **Администраторы**: полный доступ ко всем логам
- **Аудиторы**: доступ к логам безопасности и аудита

#### 3. Маскирование данных
- Автоматическое скрытие персональных данных (имена, email, телефоны, кредитные карты)
- Маскирование чувствительной бизнес-информации

### Политика хранения логов

#### 1. Индексирование по системам
- **Отдельный индекс** для каждой системы
- **Временные индексы** (daily/weekly)
- **Архивные индексы** для долгосрочного хранения
- **Hot/Warm/Cold** архитектура

#### 2. Сроки хранения
- **Горячие данные** (7 дней): детальные логи, быстрый доступ
- **Теплые данные** (30 дней): агрегированные логи, средний доступ
- **Холодные данные** (1 год): архивированные логи, медленный доступ
- **Удаление** (1+ год): автоматическое удаление старых логов

#### 3. Размеры индексов
- **Максимальный размер**: 50GB на индекс
- **Максимальное время**: 7 дней на индекс
- **Ротация**: автоматическая по размеру и времени
- **Сжатие**: gzip для архивных данных

## Превращение в систему анализа логов

### 1. Алертинг на основе логов
- **Критические ошибки**: немедленные уведомления
- **Аномальные паттерны**: уведомления о подозрительной активности
- **Производительность**: алерты на медленные операции
- **Бизнес-метрики**: алерты на отклонения в KPI

### 2. Поиск аномалий
- **Статистический анализ**: отклонения от нормальных паттернов
- **Корреляция событий**: связь между различными событиями
- **Трендовый анализ**: изменения во времени

### 3. Автоматизация диагностики
- **Автоматические отчеты**: ежедневные/еженедельные отчеты
- **Root Cause Analysis**: автоматический анализ причин проблем

### 4. Интеграция с мониторингом
- **Корреляция метрик и логов**: связь между метриками и событиями
- **Единый дашборд**: объединение мониторинга и логирования

## Дополнительное задание: Критерии выбора технологии

### Сравнительная таблица технологий

| Критерий | ELK Stack | OpenSearch | Splunk | Grafana Loki |
|----------|-----------|------------|--------|--------------|
| **Лицензия** | Elastic License | Apache License 2.0 | Проприетарная | Apache License 2.0 |
| **Стоимость** | Бесплатно (ограниченно) | Бесплатно | Дорого | Бесплатно |
| **Производительность** | Высокая | Высокая | Очень высокая | Средняя |
| **Масштабируемость** | Отличная | Отличная | Отличная | Хорошая |
| **Простота внедрения** | Средняя | Средняя | Высокая | Высокая |
| **Сообщество** | Большое | Растущее | Большое | Растущее |
| **Интеграции** | Много | Много | Очень много | Ограниченные |
| **Поддержка** | Коммерческая | Коммерческая | Полная | Сообщество |
| **Безопасность** | Хорошая | Хорошая | Отличная | Хорошая |
| **Гибкость** | Высокая | Высокая | Очень высокая | Средняя |

### Обоснование выбора ELK Stack

#### Плюсы ELK Stack
1. **Бесплатность** - нет лицензионных ограничений для базового функционала
2. **Масштабируемость** - легко масштабируется под растущие нагрузки
3. **Гибкость** - множество возможностей настройки и кастомизации
4. **Сообщество** - большое сообщество и множество ресурсов
5. **Интеграции** - множество готовых интеграций с различными системами

#### Минусы ELK Stack
1. **Сложность настройки** - требует экспертизы для оптимальной настройки
2. **Ресурсоемкость** - требует значительных ресурсов для работы
3. **Лицензионные ограничения** - некоторые функции требуют платной лицензии
4. **Кривая обучения** - команде нужно время на изучение

#### Почему не другие варианты
- **Splunk**: слишком дорого для компании такого размера
- **OpenSearch**: еще молодая технология, меньше сообщества
- **Grafana Loki**: ограниченные возможности для сложной аналитики

