# Архитектурное решение по трейсингу

## Анализ системы в контексте трейсинга

### Текущие проблемы с отслеживанием заказов
1. **Заказы зависают в непонятном состоянии** - невозможно понять, на каком этапе находится заказ
2. **Сообщения теряются в RabbitMQ** - нет видимости в интеграцию между системами
3. **Отсутствие end-to-end видимости** - невозможно отследить путь заказа через все системы
4. **Долгая диагностика проблем** - операторы и поддержка тратят часы на поиск проблем

### Системы, требующие покрытия трейсингом

#### 1. Онлайн-магазин
- **Критические точки**: Создание заказа, загрузка файла, отправка в MES
- **Потенциальные проблемы**: Таймауты при загрузке файлов, ошибки валидации

#### 2. MES (Manufacturing Execution System)
- **Критические точки**: Расчет стоимости, изменение статуса заказа, уведомления
- **Потенциальные проблемы**: Долгие расчеты (до 30 минут), зависание процессов

#### 3. CRM
- **Критические точки**: Подтверждение заказа, изменение статуса, уведомления клиентов
- **Потенциальные проблемы**: Потеря уведомлений, дублирование статусов

#### 4. RabbitMQ
- **Критические точки**: Передача сообщений между системами
- **Потенциальные проблемы**: Потеря сообщений, задержки в обработке

#### 5. API для внешних продавцов
- **Критические точки**: Внешние вызовы, расчет стоимости
- **Потенциальные проблемы**: Таймауты, ошибки интеграции

## Данные для трейсинга

### 1. Базовые данные трейса
- **Trace ID** - уникальный идентификатор трейса
- **Span ID** - идентификатор операции
- **Parent Span ID** - связь между операциями
- **Timestamp** - время начала и окончания операции
- **Duration** - длительность операции
- **Service Name** - название сервиса
- **Operation Name** - название операции

### 2. Бизнес-контекст
- **Order ID** - идентификатор заказа
- **Customer ID** - идентификатор клиента
- **Order Status** - текущий статус заказа
- **File ID** - идентификатор загруженного файла
- **API Client ID** - идентификатор внешнего клиента

### 3. Технические данные
- **HTTP Method** - метод HTTP запроса
- **HTTP Status Code** - код ответа
- **Request/Response Size** - размер данных
- **Database Query** - SQL запросы
- **External API Calls** - вызовы внешних API

### 4. Метаданные
- **User Agent** - браузер клиента
- **IP Address** - IP адрес
- **Geolocation** - геолокация
- **Device Type** - тип устройства

## Мотивация

### Почему нужен трейсинг
1. **Бизнес-критичность**: Потеря заказов напрямую влияет на выручку компании
2. **Сложность системы**: 3 приложения + интеграции через RabbitMQ
3. **Рост нагрузки**: +100 заказов в месяц требует лучшей видимости
4. **Качество сервиса**: Клиенты жалуются на просроченные заказы
5. **Операционная эффективность**: Операторы тратят много времени на поиск проблем

### Что даст трейсинг компании
- **End-to-end видимость** пути заказа через все системы
- **Быстрая диагностика** проблем (снижение MTTR с часов до минут)
- **Проактивное выявление** узких мест в системе
- **Улучшение SLA** через понимание производительности
- **Снижение операционных расходов** через автоматизацию диагностики

## Технические и бизнес-метрики

### Технические метрики
1. **Trace Success Rate** - процент успешных трейсов
2. **Average Trace Duration** - среднее время выполнения трейса
3. **P95/P99 Trace Duration** - перцентили времени выполнения
4. **Error Rate by Service** - процент ошибок по сервисам
5. **Span Count per Trace** - количество операций в трейсе

### Бизнес-метрики
1. **Order Processing Time** - время обработки заказа от создания до завершения
2. **Price Calculation Time** - время расчета стоимости
3. **Order Status Transition Time** - время перехода между статусами
4. **API Response Time** - время ответа API для внешних клиентов
5. **File Upload Success Rate** - процент успешных загрузок файлов

## Предлагаемое решение

### Технологический стек
- **Jaeger** - основная система трейсинга
- **OpenTelemetry** - стандарт для инструментирования
- **Jaeger Agent** - сбор трейсов
- **Jaeger Collector** - обработка и хранение
- **Jaeger Query** - поиск и анализ трейсов
- **Jaeger UI** - веб-интерфейс

### Архитектура решения

#### 1. Инструментирование приложений
**Java приложения (Онлайн-магазин, CRM)**:
- OpenTelemetry Java SDK
- Spring Boot integration
- HTTP client instrumentation
- Database instrumentation

**C# приложение (MES)**:
- OpenTelemetry .NET SDK
- ASP.NET Core integration
- HTTP client instrumentation
- Database instrumentation

**RabbitMQ**:
- Custom instrumentation для сообщений
- Correlation ID в заголовках сообщений
- Dead letter queue monitoring

#### 2. Сбор и хранение трейсов
- **Jaeger Agent** на каждом сервере
- **Jaeger Collector** для агрегации
- **Elasticsearch** для хранения трейсов
- **Retention policy** - 7 дней для детальных трейсов, 30 дней для агрегированных

#### 3. Анализ и визуализация
- **Jaeger UI** для поиска и анализа
- **Grafana** для дашбордов и алертов
- **Custom дашборды** для бизнес-метрик

### Обновленная диаграмма контейнеров

[Ссылка на диаграмму: architecture-alexandrite-with-tracing-and-automation.drawio]

**Примечание**: Диаграмма основана на оригинальной C4 диаграмме Александрита и включает все компоненты трейсинга и автоматизации согласно требованиям задания.

#### Компоненты трейсинга (выделены красным):
1. **Jaeger Agent** - на каждом сервере приложений
2. **Jaeger Collector** - центральный сборщик трейсов
3. **Jaeger Query** - поиск и анализ трейсов
4. **Jaeger UI** - веб-интерфейс
5. **Elasticsearch** - хранение трейсов
6. **OpenTelemetry SDK** - в каждом приложении

#### Связи трейсинга (выделены красным):
1. Приложения → OpenTelemetry SDK (инструментирование)
2. OpenTelemetry SDK → Jaeger Agent (отправка трейсов)
3. Jaeger Agent → Jaeger Collector (агрегация)
4. Jaeger Collector → Elasticsearch (хранение)
5. Jaeger Query → Elasticsearch (поиск)
6. Jaeger UI → Jaeger Query (отображение)

## Компромиссы

### Случаи, когда трейсинг не принесет пользы
1. **Простые синхронные операции** - для простых CRUD операций overhead может превышать пользу
2. **Высокочастотные операции** - трейсинг может создать нагрузку на систему
3. **Legacy системы** - старые системы могут не поддерживать инструментирование
4. **Внешние API** - невозможно трейсить вызовы к внешним системам без их поддержки

### Ограничения реализации
1. **Производительность** - трейсинг добавляет overhead (обычно 1-3%)
2. **Хранение** - трейсы занимают много места (нужна ротация)
3. **Сложность** - требует обучения команды
4. **Стоимость** - дополнительные ресурсы для хранения и обработки

### Технические ограничения
1. **Проприетарные системы** - MES может не поддерживать стандартные инструменты
2. **Сетевые ограничения** - firewall может блокировать отправку трейсов
3. **Версионность** - разные версии OpenTelemetry могут быть несовместимы

## Аспекты безопасности

### Внутренняя безопасность
1. **Аутентификация** - доступ к Jaeger UI только для авторизованных пользователей
2. **Авторизация** - ролевая модель доступа (операторы, разработчики, администраторы)
3. **Шифрование** - TLS для всех соединений
4. **Аудит** - логирование всех действий пользователей

### Защита данных
1. **Маскирование PII** - скрытие персональных данных в трейсах
2. **Retention policy** - автоматическое удаление старых трейсов
3. **Access control** - ограничение доступа к чувствительным данным
4. **Data anonymization** - обезличивание данных для аналитики

### Сетевая безопасность
1. **Firewall rules** - ограничение доступа к портам Jaeger
2. **VPN access** - доступ только через корпоративную сеть
3. **Rate limiting** - защита от DDoS атак
4. **Monitoring** - мониторинг подозрительной активности

## Дополнительное задание: Автоматический мониторинг и алертинг

### Автоматический мониторинг процесса прохождения заказа

#### 1. Мониторинг этапов заказа
- **Отслеживание времени** на каждом этапе
- **Детекция зависших заказов** (превышение SLA)
- **Анализ паттернов** успешных и неуспешных заказов
- **Корреляция с метриками** производительности

#### 2. Алертинг на основе трейсинга
- **Заказы в статусе "завис"** более 2 часов
- **Ошибки в критических операциях** (расчет стоимости, изменение статуса)
- **Аномальное время выполнения** (превышение p95 на 50%)
- **Потеря сообщений** в RabbitMQ

#### 3. Автоматические действия
- **Автоматическое масштабирование** на основе трейсов
- **Перезапуск зависших процессов**
- **Уведомления операторов** о проблемных заказах
- **Создание тикетов** для команды разработки

#### Компоненты автоматизации (выделены зеленым):
1. **Alerting Engine** - движок алертинга на основе трейсов
2. **Automation Engine** - движок автоматических действий
3. **SLA Monitor** - мониторинг SLA заказов
4. **Pattern Analyzer** - анализ паттернов в трейсах
5. **Notification Service** - сервис уведомлений

#### Связи автоматизации (выделены зеленым):
1. Jaeger Query → Alerting Engine (анализ трейсов)
2. Alerting Engine → Automation Engine (триггеры действий)
3. Automation Engine → Приложения (автоматические действия)
4. Alerting Engine → Notification Service (уведомления)
5. SLA Monitor → Jaeger Query (мониторинг SLA)

### Конфигурация алертов

#### 1. Критические алерты
- **Заказ завис более 2 часов** → PagerDuty + Slack
- **Ошибка расчета стоимости** → Slack + Email
- **Потеря сообщения в RabbitMQ** → Slack + создание тикета

#### 2. Предупреждающие алерты
- **Время выполнения превышает p95** → Slack
- **Увеличение количества ошибок** → Slack
- **Аномальное время загрузки файлов** → Slack

#### 3. Информационные алерты
- **Завершение заказа** → уведомление оператора
- **Изменение статуса заказа** → уведомление клиента
- **Успешный расчет стоимости** → уведомление в CRM

### Дашборды для операторов

#### 1. Операционный дашборд
- **Текущие заказы в работе** с временем выполнения
- **Зависшие заказы** с возможностью действий
- **Статистика по этапам** обработки заказов
- **Топ проблемных операций** за последние 24 часа

#### 2. Бизнес-дашборд
- **Время обработки заказов** по типам
- **Конверсия** по этапам
- **SLA compliance** по заказам
- **Тренды** производительности

#### 3. Технический дашборд
- **Производительность сервисов** по трейсам
- **Ошибки по сервисам** и операциям
- **Зависимости** между сервисами
- **Горячие точки** в системе
